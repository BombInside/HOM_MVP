#!/usr/bin/env bash
set -e

echo "üîç Checking Docker and Postgres connection info..."
echo "----------------------------------------------------"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
if grep -q docker /proc/1/cgroup 2>/dev/null; then
  echo "üì¶ Running INSIDE container"
  CONTEXT="container"
else
  echo "üñ•Ô∏è  Running OUTSIDE container (on host)"
  CONTEXT="host"
fi

# –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ Postgres
PG_CONTAINER=$(docker ps --format '{{.Names}}' | grep -E 'postgres' | head -n 1 || true)

if [ -z "$PG_CONTAINER" ]; then
  echo "‚ùå No Postgres container found."
  exit 1
fi

echo "üêò Postgres container: $PG_CONTAINER"

# –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Postgres
PG_USER=$(docker exec -i "$PG_CONTAINER" printenv POSTGRES_USER 2>/dev/null || echo "unknown")
PG_PASS=$(docker exec -i "$PG_CONTAINER" printenv POSTGRES_PASSWORD 2>/dev/null || echo "unknown")
PG_DB=$(docker exec -i "$PG_CONTAINER" printenv POSTGRES_DB 2>/dev/null || echo "unknown")
PG_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' "$PG_CONTAINER" 2>/dev/null || echo "unknown")

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ö–æ—Å—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if [ "$CONTEXT" = "container" ]; then
  HOST="postgres"
else
  if docker inspect "$PG_CONTAINER" | grep -q '"5432/tcp": {'; then
    HOST="localhost"
  else
    HOST="$PG_IP"
  fi
fi

echo
echo "üß© Connection details:"
echo "--------------------------------"
echo "Host:       $HOST"
echo "Port:       5432"
echo "Database:   $PG_DB"
echo "User:       $PG_USER"
echo "Password:   $PG_PASS"
echo "Container IP: $PG_IP"
echo "--------------------------------"
echo

CONN_STR="postgresql://${PG_USER}:${PG_PASS}@${HOST}:5432/${PG_DB}"
echo "üìã Connection string:"
echo "$CONN_STR"
echo

# –ü—Ä–æ–≤–µ—Ä–∏–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω psql
if command -v psql >/dev/null 2>&1; then
  echo "üîó Testing connection..."
  if PGPASSWORD="$PG_PASS" psql -h "$HOST" -U "$PG_USER" -d "$PG_DB" -c 'SELECT 1;' >/dev/null 2>&1; then
    echo "‚úÖ Connection successful!"
  else
    echo "‚ùå Connection failed. Try checking docker network or port mapping."
  fi
else
  echo "‚ö†Ô∏è  'psql' not installed; skipping connection test."
fi
