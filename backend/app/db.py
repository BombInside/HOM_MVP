# mypy: ignore-errors
from typing import AsyncGenerator
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlmodel import SQLModel
from app.config import settings
from app.models import *  # ‚úÖ –≤–∞–∂–Ω–æ: —á—Ç–æ–±—ã SQLModel –∑–Ω–∞–ª –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã


# --- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ SQLAlchemy ---
engine = create_async_engine(settings.DB_URL, future=True, echo=False)

# --- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π ---
async_session = async_sessionmaker(
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False,
)


async def get_session() -> AsyncGenerator[AsyncSession, None]:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–π –¥–ª—è Depends."""
    async with async_session() as session:
        yield session


async def create_db_and_tables() -> None:
    """
    –°–æ–∑–¥–∞—ë—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç.
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ Permission/Role/User –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –¥–æ RBAC —Å–∏–¥–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    print("üß© –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î...")
    async with engine.begin() as conn:
        await conn.run_sync(SQLModel.metadata.create_all)
    print("‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏–ª–∏ —Å–æ–∑–¥–∞–Ω—ã.")


__all__ = [
    "engine",
    "async_session",
    "get_session",
    "create_db_and_tables",
    "SQLModel",
]
