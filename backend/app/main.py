from fastapi import FastAPI, Depends
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy import text
import redis.asyncio as redis

from .error_middleware import json_error_middleware
from .graphql.schema import graphql_app
from .config import get_settings
from .db import get_session

settings = get_settings()

app = FastAPI(title="HOM Backend")

# üß± Middleware (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
app.middleware("http")(json_error_middleware)

# üåç CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
app.add_middleware(
    CORSMiddleware,
    allow_origins=[settings.CORS_ORIGINS],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# üîó GraphQL –º–∞—Ä—à—Ä—É—Ç—ã
app.include_router(graphql_app, prefix="/graphql")


# üî• Health-check endpoints
@app.get("/health")
async def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ backend API"""
    return {"status": "ok", "env": settings.APP_ENV}


@app.get("/db-health")
async def db_health(session=Depends(get_session)):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π"""
    try:
        await session.execute(text("SELECT 1"))
        return {"status": "ok"}
    except Exception:
        return {"status": "error"}


@app.get("/redis-health")
async def redis_health():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Redis"""
    try:
        r = redis.from_url(settings.REDIS_URL, decode_responses=True)
        pong = await r.ping()
        return {"status": "ok" if pong else "offline"}
    except Exception:
        return {"status": "error"}
