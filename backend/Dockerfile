FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
RUN apt-get update && apt-get install -y netcat-traditional dos2unix && rm -rf /var/lib/apt/lists/*

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å backend –∫–æ–¥
COPY . /app

# üí° –ö–æ–ø–∏—Ä—É–µ–º —à–∞–±–ª–æ–Ω Alembic script.py.mako –∏–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞
RUN mkdir -p /app/alembic && \
    cp $(python -c "import alembic, os; print(os.path.join(os.path.dirname(alembic.__file__), 'script.py.mako'))") /app/alembic/script.py.mako || true

# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º entrypoint –≤ UNIX-—Ñ–æ—Ä–º–∞—Ç
RUN chmod +x /app/entrypoint.sh && dos2unix /app/entrypoint.sh

EXPOSE 8000

ENTRYPOINT ["/app/entrypoint.sh"]
