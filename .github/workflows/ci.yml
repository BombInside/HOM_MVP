name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:

jobs:
  backend-ci:
    runs-on: ubuntu-latest
    
    # üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (Postgres –∏ Redis) –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: hom_user
          POSTGRES_PASSWORD: hom_pass
          POSTGRES_DB: hom_db
        options: >-
          --health-cmd "pg_isready -U hom_user -d hom_db"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5
          --name hom_postgres
        ports:
          - 5432:5432
      redis:
        image: redis:7.2-alpine
        # ‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω –∫–ª—é—á 'command', –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ 'options'
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 3s
          --health-timeout 3s
          --health-retries 5
          --name hom_redis
          # –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è default CMD (redis-server) –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ options
          --appendonly yes
        ports:
          - 6379:6379

    defaults:
      run:
        working-directory: backend
        
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend deps & Test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff black mypy pytest pytest-asyncio httpx

      - name: üî¨ Ruff (Check Formatting & Linting)
        # ‚úÖ –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ (Check), —á—Ç–æ–±—ã CI –Ω–µ –º–µ–Ω—è–ª –∫–æ–¥
        run: ruff check .

      - name: üé® Black (Check Formatting)
        # ‚úÖ –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞
        run: black . --check

      - name: üìù Mypy (Static Type Check)
        run: |
          mypy --ignore-missing-imports .
      
      - name: üöÄ Run Tests (Unit & Integration)
        # –¢–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Å–µ—Ä–≤–∏—Å—ã Postgres –∏ Redis –ø—Ä–æ–π–¥—É—Ç health-check
        run: |
          pytest
        env:
          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º CI
          DB_URL: postgresql+asyncpg://hom_user:hom_pass@postgres:5432/hom_db
          REDIS_URL: redis://redis:6379
          JWT_SECRET: test-secret-for-ci


  frontend-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: Build (sanity)
        env:
          VITE_API_URL: http://localhost:8000
        run: npm run build